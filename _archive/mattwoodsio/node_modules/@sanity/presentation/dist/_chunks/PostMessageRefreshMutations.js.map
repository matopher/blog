{"version":3,"file":"PostMessageRefreshMutations.js","sources":["../../src/editor/PostMessageRefreshMutations.tsx"],"sourcesContent":["import type { ChannelsController, ChannelStatus } from '@sanity/channels'\nimport type { PresentationMsg } from '@sanity/visual-editing-helpers'\nimport { memo, startTransition, useEffect, useMemo, useState } from 'react'\nimport { getPublishedId, type SanityDocument, useEditState } from 'sanity'\n\nexport interface PostMessageRefreshMutationsProps {\n  id: string\n  type: string\n  channel: ChannelsController<PresentationMsg>\n  previewKitConnection: ChannelStatus\n  loadersConnection: ChannelStatus\n}\n\nfunction PostMessageRefreshMutations(\n  props: PostMessageRefreshMutationsProps,\n): React.ReactNode {\n  const { channel, type, previewKitConnection, loadersConnection } = props\n  const id = useMemo(() => getPublishedId(props.id), [props.id])\n  const { draft, published, ready } = useEditState(id, type, 'low')\n  const livePreviewEnabled =\n    previewKitConnection === 'connected' || loadersConnection === 'connected'\n\n  if ((ready && draft) || published) {\n    return (\n      <PostMessageRefreshMutationsInner\n        key={id}\n        channel={channel}\n        draft={draft}\n        livePreviewEnabled={livePreviewEnabled}\n        published={published}\n      />\n    )\n  }\n\n  return null\n}\n\ninterface PostMessageRefreshMutationsInnerProps\n  extends Pick<PostMessageRefreshMutationsProps, 'channel'> {\n  livePreviewEnabled: boolean\n  draft: SanityDocument | null\n  published: SanityDocument | null\n}\nfunction PostMessageRefreshMutationsInner(\n  props: PostMessageRefreshMutationsInnerProps,\n) {\n  const { channel, draft, published, livePreviewEnabled } = props\n  const [prevDraft, setPrevDraft] = useState(draft)\n  const [prevPublished, setPrevPublished] = useState(published)\n\n  useEffect(() => {\n    if (prevDraft?._rev !== draft?._rev) {\n      startTransition(() => setPrevDraft(draft))\n      if (draft) {\n        channel?.send('overlays', 'presentation/refresh', {\n          source: 'mutation',\n          livePreviewEnabled,\n          document: parseDocument(draft),\n        })\n      }\n    }\n    if (prevPublished?._rev !== published?._rev) {\n      startTransition(() => setPrevPublished(published))\n      if (published) {\n        channel?.send('overlays', 'presentation/refresh', {\n          source: 'mutation',\n          livePreviewEnabled,\n          document: parseDocument(published),\n        })\n      }\n    }\n  }, [\n    channel,\n    draft,\n    livePreviewEnabled,\n    prevDraft?._rev,\n    prevPublished?._rev,\n    published,\n  ])\n\n  return null\n}\n\nfunction parseDocument(\n  document: SanityDocument & { slug?: { current?: string | null } },\n): {\n  _id: string\n  _type: string\n  _rev: string\n  slug?: { current?: string | null }\n} {\n  const { _id, _type, _rev, slug } = document\n  return { _id, _type, _rev, slug }\n}\n\nexport default memo(PostMessageRefreshMutations)\n"],"names":["PostMessageRefreshMutationsInner","props","channel","draft","published","livePreviewEnabled","prevDraft","setPrevDraft","useState","prevPublished","setPrevPublished","useEffect","_rev","startTransition","send","source","document","parseDocument","_id","_type","slug","PostMessageRefreshMutations$1","memo","type","previewKitConnection","loadersConnection","id","useMemo","getPublishedId","ready","useEditState","jsx"],"mappings":"8LA2CA,SAASA,EACPC,GAEA,MAAMC,QAAEA,EAASC,MAAAA,EAAAC,UAAOA,qBAAWC,GAAuBJ,GACnDK,EAAWC,GAAgBC,EAASL,IACpCM,EAAeC,GAAoBF,EAASJ,GAEnD,OAAAO,GAAU,MACO,MAAXL,OAAW,EAAAA,EAAAM,SAAgB,MAAPT,OAAO,EAAAA,EAAAS,QAC7BC,GAAgB,IAAMN,EAAaJ,KAC/BA,IACO,MAATD,GAASA,EAAAY,KAAK,WAAY,uBAAwB,CAChDC,OAAQ,WACRV,qBACAW,SAAUC,EAAcd,QAI1B,MAAAM,OAAA,EAAAA,EAAeG,SAAS,MAAAR,OAAA,EAAAA,EAAWQ,QACrCC,GAAgB,IAAMH,EAAiBN,KACnCA,IACO,MAATF,GAASA,EAAAY,KAAK,WAAY,uBAAwB,CAChDC,OAAQ,WACRV,qBACAW,SAAUC,EAAcb,MAC1B,GAGH,CACDF,EACAC,EACAE,EACW,MAAXC,OAAW,EAAAA,EAAAM,KACI,MAAfH,OAAe,EAAAA,EAAAG,KACfR,IAGK,IACT,CAEA,SAASa,EACPD,GAOA,MAAME,IAAEA,EAAAC,MAAKA,EAAOP,KAAAA,EAAAQ,KAAMA,GAASJ,EACnC,MAAO,CAAEE,MAAKC,QAAOP,OAAMQ,OAC7B,CAEA,IAAeC,EAAAC,GAlFf,SACErB,GAEM,MAAAC,QAAEA,EAASqB,KAAAA,EAAAC,qBAAMA,EAAsBC,kBAAAA,GAAsBxB,EAC7DyB,EAAKC,GAAQ,IAAMC,EAAe3B,EAAMyB,KAAK,CAACzB,EAAMyB,MACpDvB,MAAEA,EAAAC,UAAOA,EAAWyB,MAAAA,GAAUC,EAAaJ,EAAIH,EAAM,OAItD,OAAAM,GAAS1B,GAAUC,EAEpB2B,EAAC/B,EAAA,CAECE,UACAC,QACAE,mBARqB,cAAzBmB,GAA8D,cAAtBC,EASpCrB,aAJKsB,GASJ,IACT"}