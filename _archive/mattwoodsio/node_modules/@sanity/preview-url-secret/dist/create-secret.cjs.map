{"version":3,"file":"create-secret.cjs","sources":["../src/generateSecret.ts","../src/createPreviewSecret.ts"],"sourcesContent":["/** @internal */\nexport function generateUrlSecret(): string {\n  // Try using WebCrypto if available\n  if (typeof crypto !== 'undefined') {\n    // Generate a random array of 16 bytes\n    const array = new Uint8Array(16)\n    crypto.getRandomValues(array)\n\n    // Convert the array to a URL-safe string\n    let key = ''\n    for (let i = 0; i < array.length; i++) {\n      // Convert each byte to a 2-digit hexadecimal number\n      key += array[i].toString(16).padStart(2, '0')\n    }\n\n    // Replace '+' and '/' from base64url to '-' and '_'\n    key = btoa(key).replace(/\\+/g, '-').replace(/\\//g, '_').replace(/[=]+$/, '')\n\n    return key\n  }\n  // If not fallback to Math.random\n  return Math.random().toString(36).slice(2)\n}\n","import type { SanityClient } from '@sanity/client'\nimport { uuid } from '@sanity/uuid'\n\nimport {\n  apiVersion,\n  deleteExpiredSecretsQuery,\n  schemaIdPrefix,\n  schemaType,\n  SECRET_TTL,\n  tag,\n} from './constants'\nimport { generateUrlSecret } from './generateSecret'\nimport { SanityClientLike } from './types'\n\n/** @internal */\nexport async function createPreviewSecret(\n  _client: SanityClient,\n  source: string,\n  studioUrl: string,\n  userId?: string,\n  id = uuid(),\n): Promise<{ secret: string; expiresAt: Date }> {\n  const client = _client.withConfig({ apiVersion })\n\n  try {\n    const expiresAt = new Date(Date.now() + 1000 * SECRET_TTL)\n    const _id = `${schemaIdPrefix}.${id}`\n    const newSecret = generateUrlSecret()\n    const patch = client\n      .patch(_id)\n      .set({ secret: newSecret, source, studioUrl, userId })\n    await client\n      .transaction()\n      .createOrReplace({ _id, _type: schemaType })\n      .patch(patch)\n      .commit({ tag })\n\n    return { secret: newSecret, expiresAt }\n  } finally {\n    // Garbage collect expired secrets\n    await client.delete({ query: deleteExpiredSecretsQuery })\n  }\n}\n\nexport type { SanityClientLike }\n"],"names":["Object","defineProperty","exports","value","uuid","require","constants","createPreviewSecret","async","_client","source","studioUrl","userId","id","client","withConfig","apiVersion","expiresAt","Date","now","SECRET_TTL","_id","schemaIdPrefix","s","newSecret","crypto","array","Uint8Array","getRandomValues","key","i","length","toString","padStart","btoa","replace","Math","random","slice","generateUrlSecret","patch","set","secret","transaction","createOrReplace","_type","schemaType","commit","tag","t","delete","query","deleteExpiredSecretsQuery"],"mappings":"aACOA,OAAAC,eAAAC,QAAA,aAAA,CAAAC,OAAA,IAAA,IAAAC,EAAAC,QAAA,gBAAAC,EAAAD,QAAA,2BCyCPH,QAAAK,oBA3BAC,eACEC,EACAC,EACAC,EACAC,EACAC,EAAKT,EAAAA,QAEL,MAAMU,EAASL,EAAQM,WAAW,CAAEC,WAAAA,EAAAA,IAEhC,IACF,MAAMC,EAAY,IAAIC,KAAKA,KAAKC,MAAQ,IAAOC,KACzCC,EAAM,GAAGC,EAAcC,KAAIV,IAC3BW,ED1BH,WAED,UAAOC,OAAW,IAAa,CAE3B,MAAAC,EAAQ,IAAIC,WAAW,IAC7BF,OAAOG,gBAAgBF,GAGvB,IAAIG,EAAM,GACV,IAAA,IAASC,EAAI,EAAGA,EAAIJ,EAAMK,OAAQD,IAEzBD,GAAAH,EAAMI,GAAGE,SAAS,IAAIC,SAAS,EAAG,KAI3C,OAAAJ,EAAMK,KAAKL,GAAKM,QAAQ,MAAO,KAAKA,QAAQ,MAAO,KAAKA,QAAQ,QAAS,IAElEN,CACT,CAEA,OAAOO,KAAKC,SAASL,SAAS,IAAIM,MAAM,EAC1C,CCKsBC,GACZC,EAAQ1B,EACX0B,MAAMnB,GACNoB,IAAI,CAAEC,OAAQlB,EAAWd,SAAQC,YAAWC,WACzC,aAAAE,EACH6B,cACAC,gBAAgB,CAAEvB,MAAKwB,MAAOC,EAAAA,IAC9BN,MAAMA,GACNO,OAAO,KAAEC,EAAAC,IAEL,CAAEP,OAAQlB,EAAWP,YAAU,CACtC,cAEMH,EAAOoC,OAAO,CAAEC,MAAOC,EAAAA,GAC/B,CACF"}