{"version":3,"file":"createSafeJsonParser.js","sources":["../src/createSafeJsonParser.ts"],"sourcesContent":["interface Options {\n  errorLabel: string\n}\n\ntype Parser<Type> = (line: string) => Type\n\n/**\n * Create a safe JSON parser that is able to handle lines interrupted by an error object.\n *\n * This may occur when streaming NDJSON from the Export HTTP API.\n *\n * @internal\n * @see {@link https://github.com/sanity-io/sanity/pull/1787 | Initial pull request}\n */\nexport function createSafeJsonParser<Type>({errorLabel}: Options): Parser<Type> {\n  return function safeJsonParser(line) {\n    try {\n      return JSON.parse(line)\n    } catch (err) {\n      // Catch half-done lines with an error at the end\n      const errorPosition = line.lastIndexOf('{\"error\":')\n      if (errorPosition === -1) {\n        err.message = `${err.message} (${line})`\n        throw err\n      }\n\n      const errorJson = line.slice(errorPosition)\n      const errorLine = JSON.parse(errorJson)\n      const error = errorLine && errorLine.error\n      if (error && error.description) {\n        throw new Error(`${errorLabel}: ${error.description}\\n\\n${errorJson}\\n`)\n      }\n\n      throw err\n    }\n  }\n}\n"],"names":["createSafeJsonParser","_ref","errorLabel","safeJsonParser","line","JSON","parse","err","errorPosition","lastIndexOf","message","concat","errorJson","slice","errorLine","error","description","Error"],"mappings":";;;;;AAcgB,SAAAA,oBAAAA,CAAAC,IAAA,EAAgE;EAAA,IAArC;IAACC;GAAoC,GAAAD,IAAA;EACvE,OAAA,SAASE,eAAeC,IAAM,EAAA;IAC/B,IAAA;MACK,OAAAC,IAAA,CAAKC,MAAMF,IAAI,CAAA;aACfG,GAAK,EAAA;MAEN,MAAAC,aAAA,GAAgBJ,IAAK,CAAAK,WAAA,CAAY,WAAW,CAAA;MAClD,IAAID,kBAAkB,CAAI,CAAA,EAAA;QACxBD,GAAA,CAAIG,OAAU,GAAA,EAAA,CAAGC,MAAI,CAAAJ,GAAA,CAAAG,OAAA,EAAO,MAAKC,MAAI,CAAAP,IAAA,EAAA,GAAA,CAAA;QAC/B,MAAAG,GAAA;MACR;MAEM,MAAAK,SAAA,GAAYR,IAAK,CAAAS,KAAA,CAAML,aAAa,CAAA;MACpC,MAAAM,SAAA,GAAYT,IAAK,CAAAC,KAAA,CAAMM,SAAS,CAAA;MAChC,MAAAG,KAAA,GAAQD,aAAaA,SAAU,CAAAC,KAAA;MACjC,IAAAA,KAAA,IAASA,MAAMC,WAAa,EAAA;QACxB,MAAA,IAAIC,MAAM,EAAG,CAAAN,MAAA,CAAAT,UAAA,EAAU,MAAKS,MAAM,CAAAI,KAAA,CAAAC,WAAA,EAAW,MAAO,CAAA,CAAAL,MAAA,CAAAC,SAAA,EAAS,IAAI,CAAA,CAAA;MACzE;MAEM,MAAAL,GAAA;IACR;EAAA,CACF;AACF;"}