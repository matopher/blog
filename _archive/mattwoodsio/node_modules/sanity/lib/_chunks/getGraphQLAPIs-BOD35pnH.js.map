{"version":3,"file":"getGraphQLAPIs-BOD35pnH.js","sources":["../../src/_internal/cli/actions/graphql/getGraphQLAPIs.ts"],"sourcesContent":["import {type CliCommandContext, type CliV3CommandContext} from '@sanity/cli'\nimport path from 'path'\nimport readPkgUp from 'read-pkg-up'\nimport {createSchema} from 'sanity'\nimport {isMainThread, Worker} from 'worker_threads'\n\nimport {\n  type ResolvedGraphQLAPI,\n  type ResolvedSourceProperties,\n  type SchemaDefinitionish,\n  type TypeResolvedGraphQLAPI,\n} from './types'\n\nexport async function getGraphQLAPIs(cliContext: CliCommandContext): Promise<ResolvedGraphQLAPI[]> {\n  if (!isModernCliConfig(cliContext)) {\n    throw new Error('Expected Sanity studio of version 3 or above')\n  }\n\n  if (!isMainThread) {\n    throw new Error('getGraphQLAPIs() must be called from the main thread')\n  }\n\n  const defaultSchema = createSchema({name: 'default', types: []})\n  const defaultTypes = defaultSchema.getTypeNames()\n  const isCustomType = (type: SchemaDefinitionish) => !defaultTypes.includes(type.name)\n\n  const apis = await getApisWithSchemaTypes(cliContext)\n  const resolved = apis.map(\n    ({schemaTypes, ...api}): ResolvedSourceProperties => ({\n      schema: createSchema({name: 'default', types: schemaTypes.filter(isCustomType)}),\n      ...api,\n    }),\n  )\n\n  return resolved\n}\n\nfunction getApisWithSchemaTypes(cliContext: CliCommandContext): Promise<TypeResolvedGraphQLAPI[]> {\n  return new Promise<TypeResolvedGraphQLAPI[]>((resolve, reject) => {\n    const {cliConfig, cliConfigPath, workDir} = cliContext\n    const rootPkgPath = readPkgUp.sync({cwd: __dirname})?.path\n    if (!rootPkgPath) {\n      throw new Error('Could not find root directory for `sanity` package')\n    }\n\n    const rootDir = path.dirname(rootPkgPath)\n    const workerPath = path.join(rootDir, 'lib', '_internal', 'cli', 'threads', 'getGraphQLAPIs.js')\n    const worker = new Worker(workerPath, {\n      workerData: {cliConfig: serialize(cliConfig || {}), cliConfigPath, workDir},\n      // eslint-disable-next-line no-process-env\n      env: process.env,\n    })\n    worker.on('message', resolve)\n    worker.on('error', reject)\n    worker.on('exit', (code) => {\n      if (code !== 0) reject(new Error(`Worker stopped with exit code ${code}`))\n    })\n  })\n}\n\nfunction isModernCliConfig(config: CliCommandContext): config is CliV3CommandContext {\n  return config.sanityMajorVersion >= 3\n}\n\nfunction serialize<T>(obj: T): T {\n  try {\n    return JSON.parse(JSON.stringify(obj))\n  } catch (cause) {\n    throw new Error(`Failed to serialize CLI configuration`, {cause})\n  }\n}\n"],"names":["getGraphQLAPIs","cliContext","isModernCliConfig","Error","isMainThread","defaultSchema","createSchema","name","types","defaultTypes","getTypeNames","isCustomType","type","includes","apis","getApisWithSchemaTypes","resolved","map","_ref","schemaTypes","api","schema","filter","Promise","resolve","reject","_a","cliConfig","cliConfigPath","workDir","rootPkgPath","sync","cwd","__dirname","path","rootDir","dirname","workerPath","join","worker","Worker","workerData","serialize","env","process","on","code","concat","config","sanityMajorVersion","obj","JSON","parse","stringify","cause"],"mappings":";;;;;;;;;;;;;AAaA,eAAsBA,eAAeC,UAA8D,EAAA;EAC7F,IAAA,CAACC,iBAAkB,CAAAD,UAAU,CAAG,EAAA;IAC5B,MAAA,IAAIE,MAAM,8CAA8C,CAAA;EAChE;EAEA,IAAI,CAACC,cAAAA,CAAAA,YAAc,EAAA;IACX,MAAA,IAAID,MAAM,sDAAsD,CAAA;EACxE;EAEM,MAAAE,aAAA,GAAgBC,MAAAA,CAAAA,aAAa;IAACC,IAAA,EAAM;IAAWC,KAAO,EAAA;GAAG,CAAA;EACzD,MAAAC,YAAA,GAAeJ,cAAcK,YAAa,EAAA;EAChD,MAAMC,eAAgBC,IAAA,IAA8B,CAACH,YAAa,CAAAI,QAAA,CAASD,KAAKL,IAAI,CAAA;EAE9E,MAAAO,IAAA,GAAO,MAAMC,sBAAA,CAAuBd,UAAU,CAAA;EACpD,MAAMe,WAAWF,IAAK,CAAAG,GAAA,CACpBC,IAAA;IAAA,IAAC;MAACC,WAAa;MAAA,GAAGC;KAAoC,GAAAF,IAAA;IAAA,OAAA;MACpDG,MAAA,EAAQf,MAAAA,CAAAA,YAAa,CAAA;QAACC,IAAM,EAAA,SAAA;QAAWC,OAAOW,WAAY,CAAAG,MAAA,CAAOX,YAAY;OAAE,CAAA;MAC/E,GAAGS;IAAA,CACL;EAAA,CAAA,CACF;EAEO,OAAAJ,QAAA;AACT;AAEA,SAASD,uBAAuBd,UAAkE,EAAA;EAChG,OAAO,IAAIsB,OAAA,CAAkC,CAACC,OAAA,EAASC,MAAW,KAAA;IAtCpE,IAAAC,EAAA;IAuCI,MAAM;MAACC,SAAA;MAAWC,aAAe;MAAAC;IAAA,CAAW,GAAA5B,UAAA;IACtC,MAAA6B,WAAA,GAAA,CAAcJ,gCAAUK,IAAK,CAAA;MAACC,KAAKC;IAAS,CAAC,MAA/B,IAAkC,GAAA,KAAA,CAAA,GAAAP,EAAA,CAAAQ,IAAA;IACtD,IAAI,CAACJ,WAAa,EAAA;MACV,MAAA,IAAI3B,MAAM,oDAAoD,CAAA;IACtE;IAEM,MAAAgC,OAAA,GAAUD,aAAAA,CAAAA,OAAK,CAAAE,OAAA,CAAQN,WAAW,CAAA;IAClC,MAAAO,UAAA,GAAaH,sBAAKI,IAAK,CAAAH,OAAA,EAAS,OAAO,WAAa,EAAA,KAAA,EAAO,WAAW,mBAAmB,CAAA;IACzF,MAAAI,MAAA,GAAS,IAAIC,cAAA,CAAAA,MAAA,CAAOH,UAAY,EAAA;MACpCI,UAAA,EAAY;QAACd,SAAW,EAAAe,SAAA,CAAUf,aAAa,EAAE,CAAG;QAAAC,aAAA;QAAeC;MAAO,CAAA;MAAA;MAE1Ec,KAAKC,OAAQ,CAAAD;IAAA,CACd,CAAA;IACMJ,MAAA,CAAAM,EAAA,CAAG,WAAWrB,OAAO,CAAA;IACrBe,MAAA,CAAAM,EAAA,CAAG,SAASpB,MAAM,CAAA;IAClBc,MAAA,CAAAM,EAAA,CAAG,MAAQ,EAACC,IAAS,IAAA;MAC1B,IAAIA,IAAS,KAAA,CAAA,EAAGrB,MAAA,CAAO,IAAItB,KAAA,CAAM,gCAAiC,CAAA4C,MAAA,CAAAD,IAAA,CAAM,CAAC,CAAA;IAAA,CAC1E,CAAA;EAAA,CACF,CAAA;AACH;AAEA,SAAS5C,kBAAkB8C,MAA0D,EAAA;EACnF,OAAOA,OAAOC,kBAAsB,IAAA,CAAA;AACtC;AAEA,SAASP,UAAaQ,GAAW,EAAA;EAC3B,IAAA;IACF,OAAOC,IAAK,CAAAC,KAAA,CAAMD,IAAK,CAAAE,SAAA,CAAUH,GAAG,CAAC,CAAA;WAC9BI,KAAO,EAAA;IACd,MAAM,IAAInD,KAAA,CAAM,uCAAyC,EAAA;MAACmD;IAAM,CAAA,CAAA;EAClE;AACF;"}